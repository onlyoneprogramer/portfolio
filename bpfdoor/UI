import sys
import os
import re
from collections import Counter, defaultdict
from datetime import datetime

from PyQt5.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QTextEdit, QLabel, QFileDialog,
    QMessageBox, QLineEdit, QTabWidget, QCheckBox
)
from PyQt5.QtCore import QTimer
from PyQt5.QtGui import QTextCursor, QTextCharFormat, QColor

from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure

LOG_FILE = "sample_bpfdoor_log.txt"  # ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •

class BPFdoorMonitor(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("BPFdoor íƒì§€ ë¡œê·¸ ëª¨ë‹ˆí„°")
        self.setGeometry(100, 100, 900, 900)

        self.full_log = ""  # ì „ì²´ ë¡œê·¸ ì›ë³¸
        self.prev_alert_count = 0  # ê²½ê³  ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ìš©
        self.alert_enabled = True  # ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€

        main_layout = QVBoxLayout()

        # íƒ­ ìœ„ì ¯ ìƒì„±
        self.tabs = QTabWidget()
        main_layout.addWidget(self.tabs)

        # 1) íƒì§€ ë¡œê·¸ íƒ­
        self.tab_log = QWidget()
        self.init_log_tab()
        self.tabs.addTab(self.tab_log, "ğŸ“„ íƒì§€ ë¡œê·¸")

        # 2) ì‹¤ì‹œê°„ íƒì§€ íƒ­
        self.tab_realtime = QWidget()
        self.init_realtime_tab()
        self.tabs.addTab(self.tab_realtime, "â± ì‹¤ì‹œê°„ íƒì§€")

        # 3) ì„¤ì • íƒ­
        self.tab_settings = QWidget()
        self.init_settings_tab()
        self.tabs.addTab(self.tab_settings, "âš™ï¸ ì„¤ì •")

        self.setLayout(main_layout)

        # ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ (íƒì§€ ë¡œê·¸ íƒ­ì—ë§Œ ì ìš©)
        self.timer = QTimer()
        self.timer.timeout.connect(self.load_logs)
        self.timer.start(3000)

        self.load_logs()

     
    def init_log_tab(self):
        layout = QVBoxLayout()

        # ê²€ìƒ‰ì°½
        search_layout = QHBoxLayout()
        self.search_box = QLineEdit()
        self.search_box.setPlaceholderText("ğŸ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì—¬ í•„í„°ë§")
        self.search_box.textChanged.connect(self.filter_logs)
        search_layout.addWidget(QLabel("ê²€ìƒ‰ì–´:"))
        search_layout.addWidget(self.search_box)
        layout.addLayout(search_layout)

        # ë¡œê·¸ ì¶œë ¥ì°½
        self.text_area = QTextEdit()
        self.text_area.setReadOnly(True)
        layout.addWidget(self.text_area)

        # íƒì§€ í†µê³„ í…ìŠ¤íŠ¸ ë¼ë²¨
        self.stats_label = QLabel("ğŸ“Š íƒì§€ í†µê³„: ì—†ìŒ")
        layout.addWidget(self.stats_label)

        # matplotlib ê·¸ë˜í”„ ì˜ì—­ (ë§‰ëŒ€ê·¸ë˜í”„)
        self.figure_bar = Figure(figsize=(5, 2))
        self.canvas_bar = FigureCanvas(self.figure_bar)
        layout.addWidget(self.canvas_bar)

        # matplotlib ê·¸ë˜í”„ ì˜ì—­ (íƒ€ì„ë¼ì¸ ë¼ì¸ì°¨íŠ¸)
        self.figure_line = Figure(figsize=(5, 2))
        self.canvas_line = FigureCanvas(self.figure_line)
        layout.addWidget(self.canvas_line)

        # í•˜ë‹¨ ë²„íŠ¼
        button_layout = QHBoxLayout()
        self.refresh_btn = QPushButton("ğŸ” ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨")
        self.refresh_btn.clicked.connect(self.load_logs)
        button_layout.addWidget(self.refresh_btn)

        self.save_btn = QPushButton("ğŸ’¾ ë¡œê·¸ ì €ì¥")
        self.save_btn.clicked.connect(self.save_log)
        button_layout.addWidget(self.save_btn)

        layout.addLayout(button_layout)
        self.tab_log.setLayout(layout)

    def init_realtime_tab(self):
        layout = QVBoxLayout()

        self.realtime_label = QLabel("ì‹¤ì‹œê°„ íƒì§€ ì¤‘...")
        layout.addWidget(self.realtime_label)

        self.realtime_refresh_btn = QPushButton("ğŸ” ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨")
        self.realtime_refresh_btn.clicked.connect(self.load_logs)
        layout.addWidget(self.realtime_refresh_btn)

        self.tab_realtime.setLayout(layout)

    def init_settings_tab(self):
        layout = QVBoxLayout()

        self.alert_checkbox = QCheckBox("ğŸš¨ ê²½ê³  ì•Œë¦¼ í™œì„±í™”")
        self.alert_checkbox.setChecked(True)
        self.alert_checkbox.stateChanged.connect(self.toggle_alert)
        layout.addWidget(self.alert_checkbox)

        layout.addStretch()
        self.tab_settings.setLayout(layout)

    def toggle_alert(self, state):
        self.alert_enabled = (state == 2)  # 2 = Checked

    def load_logs(self):
        try:
            with open(LOG_FILE, "r") as f:
                self.full_log = f.read()
            self.filter_logs()
            self.update_stats()
        except PermissionError:
            self.text_area.setPlainText("[ERROR] ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. sudoë¡œ ì‹¤í–‰í•˜ê±°ë‚˜ ê¶Œí•œ í™•ì¸í•˜ì„¸ìš”.")
        except FileNotFoundError:
            self.text_area.setPlainText(f"[ERROR] ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {LOG_FILE}")

    def filter_logs(self):
        keyword = self.search_box.text().lower()
        lines = self.full_log.splitlines()

        if keyword:
            filtered = [line for line in lines if keyword in line.lower()]
        else:
            filtered = lines

        display_text = "\n".join(filtered)
        self.text_area.setPlainText(display_text)
        self.highlight_keywords()

    def highlight_keywords(self):
        cursor = self.text_area.textCursor()
        cursor.movePosition(QTextCursor.Start)

        highlight_words = {
            "bpfdoor": QColor("red"),
            "suspicious": QColor("orange"),
            "alert": QColor("magenta"),
            "rootkit": QColor("purple")
        }

        for keyword, color in highlight_words.items():
            fmt = QTextCharFormat()
            fmt.setForeground(color)

            cursor.movePosition(QTextCursor.Start)
            while cursor.find(keyword, QTextCursor.FindCaseSensitively):
                cursor.mergeCharFormat(fmt)

    def update_stats(self):
        lines = self.full_log.lower().splitlines()
        counters = Counter()

        for line in lines:
            if "suspicious" in line:
                counters["Suspicious"] += 1
            if "bpfdoor" in line:
                counters["BPFdoor"] += 1
            if "alert" in line:
                counters["ALERT"] += 1
            if "rootkit" in line:
                counters["Rootkit"] += 1

        # ê²½ê³  ì•Œë¦¼ íŠ¸ë¦¬ê±° (ì„¤ì • ì²´í¬ë°•ìŠ¤ì— ë”°ë¼ ë™ì‘)
        alert_sum = counters["BPFdoor"] + counters["Rootkit"] + counters["ALERT"]
        if self.alert_enabled and alert_sum > self.prev_alert_count:
            QMessageBox.warning(self, "ìœ„í—˜ íƒì§€", f"ğŸš¨ ì˜ì‹¬ ë¡œê·¸ê°€ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ {alert_sum} ê±´\n(bpfdoor/rootkit/alert í¬í•¨)")
            self.prev_alert_count = alert_sum

        # í…ìŠ¤íŠ¸ ì¶œë ¥
        if counters:
            stats_text = " / ".join(f"{k}: {v}" for k, v in counters.items())
        else:
            stats_text = "ì—†ìŒ"

        self.stats_label.setText(f"ğŸ“Š íƒì§€ í†µê³„: {stats_text}")
        self.plot_bar_chart(counters)
        self.plot_timeline_chart(self.full_log)

        # ì‹¤ì‹œê°„íƒ­ì—ë„ í†µê³„ í‘œì‹œ (ê°„ë‹¨)
        self.realtime_label.setText(f"ìµœê·¼ íƒì§€: {stats_text}")

    def plot_bar_chart(self, counters):
        self.figure_bar.clear()
        ax = self.figure_bar.add_subplot(111)
        labels = list(counters.keys())
        values = [counters[k] for k in labels]

        ax.bar(labels, values, color=["orange", "red", "magenta", "purple"])
        ax.set_title("íƒì§€ í‚¤ì›Œë“œ í†µê³„")
        ax.set_ylabel("íƒì§€ íšŸìˆ˜")
        self.figure_bar.tight_layout()
        self.canvas_bar.draw()

    def plot_timeline_chart(self, full_log_text):
        # íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ì´ë²¤íŠ¸ í‚¤ì›Œë“œë³„ ë°œìƒ ìˆ˜ ì§‘ê³„ (ë¶„ ë‹¨ìœ„)
        # ë¡œê·¸ ë¼ì¸ ì˜ˆì‹œ: "[2025-07-24 10:11:12] suspicious activity detected ..."
        # ì‹¤ì œ ë¡œê·¸ í˜•ì‹ì— ë§ê²Œ ì •ê·œì‹ ìˆ˜ì • í•„ìš”

        time_event_counts = defaultdict(lambda: defaultdict(int))
        timestamp_regex = re.compile(r"\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}):\d{2}\]")  # ë¶„ ë‹¨ìœ„ê¹Œì§€ ìº¡ì²˜

        keywords = ["bpfdoor", "suspicious", "alert", "rootkit"]

        for line in full_log_text.splitlines():
            ts_match = timestamp_regex.search(line)
            if not ts_match:
                continue
            time_key = ts_match.group(1)  # 'YYYY-MM-DD HH:MM'
            line_lower = line.lower()
            for kw in keywords:
                if kw in line_lower:
                    time_event_counts[kw][time_key] += 1

        # ì‹œê°„ ì¶• ì •ë ¬
        all_times = set()
        for kw in keywords:
            all_times.update(time_event_counts[kw].keys())
        all_times = sorted(all_times)

        if not all_times:
            # ë¡œê·¸ì— íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìœ¼ë©´ ê·¸ë˜í”„ ê·¸ë¦¬ì§€ ì•ŠìŒ
            self.figure_line.clear()
            ax = self.figure_line.add_subplot(111)
            ax.text(0.5, 0.5, "íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ ë¡œê·¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.", ha='center', va='center')
            ax.axis('off')
            self.canvas_line.draw()
            return

        # ê° í‚¤ì›Œë“œë³„ ì‹œê°„ëŒ€ë³„ ì´ë²¤íŠ¸ ìˆ˜ ë°°ì—´ ìƒì„± (0 í¬í•¨)
        series_data = {}
        for kw in keywords:
            series_data[kw] = [time_event_counts[kw].get(t, 0) for t in all_times]

        # ë‚ ì§œ/ì‹œê°„ ë¬¸ìì—´ì„ matplotlib xì¶•ìš© ìˆ«ì ë˜ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© (ê°„ë‹¨íˆ ë¬¸ìì—´ ê·¸ëŒ€ë¡œ)
        x = all_times

        self.figure_line.clear()
        ax = self.figure_line.add_subplot(111)

        colors = {
            "bpfdoor": "red",
            "suspicious": "orange",
            "alert": "magenta",
            "rootkit": "purple"
        }

        for kw in keywords:
            ax.plot(x, series_data[kw], label=kw.capitalize(), color=colors.get(kw, "black"), marker='o')

        ax.set_title("ì´ë²¤íŠ¸ë³„ íƒ€ì„ë¼ì¸ (ë¶„ ë‹¨ìœ„)")
        ax.set_xlabel("ì‹œê°„ (YYYY-MM-DD HH:MM)")
        ax.set_ylabel("ì´ë²¤íŠ¸ ìˆ˜")
        ax.legend()
        ax.tick_params(axis='x', rotation=45)
        self.figure_line.tight_layout()
        self.canvas_line.draw()

    def save_log(self):
        path, _ = QFileDialog.getSaveFileName(self, "ë¡œê·¸ ì €ì¥", "bpfdoor_log.txt", "Text Files (*.txt)")
        if path:
            with open(path, "w") as f:
                f.write(self.text_area.toPlainText())
            QMessageBox.information(self, "ì €ì¥ ì™„ë£Œ", f"ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:\n{path}")

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = BPFdoorMonitor()
    window.show()
    sys.exit(app.exec_())
